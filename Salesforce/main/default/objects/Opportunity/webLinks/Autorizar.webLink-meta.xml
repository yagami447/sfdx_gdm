<?xml version="1.0" encoding="UTF-8"?>
<WebLink xmlns="http://soap.sforce.com/2006/04/metadata">
    <fullName>Autorizar</fullName>
    <availability>online</availability>
    <displayType>button</displayType>
    <linkType>javascript</linkType>
    <masterLabel>Autorizar</masterLabel>
    <openType>onClickJavaScript</openType>
    <protected>false</protected>
    <url>{!REQUIRESCRIPT(&quot;/soap/ajax/10.0/connection.js&quot;)}
{!REQUIRESCRIPT(&quot;/soap/ajax/10.0/apex.js&quot;)}

var id = &quot;{!Opportunity.Id}&quot;;
var nro = &quot;{!Opportunity.Name}&quot;;
var stage = &quot;{!Opportunity.StageName}&quot;;
var idOrigen = &quot;{!Opportunity.Origen__c}&quot;;
var fecha_tipo_cambio = &quot;{!Opportunity.Fecha_fijacion_T_de_cambio__c}&quot;;
var tipo_cambio = &quot;{!Opportunity.Tipo_de_cambio__c}&quot;;
var sucursal = &quot;{!Opportunity.Sucursal__c}&quot;;

var condicion_pago = &quot;{!Opportunity.Condicion_de_Pago__c}&quot;;
var tipo = &quot;{!Opportunity.Tipo__c}&quot;;
var rt_opp = &quot;{!Opportunity.RecordTypeId}&quot;;
var tieneOpli = &quot;{!Opportunity.HasOpportunityLineItem}&quot;;
var resp = &apos;&apos;;
resp = &quot;{!Opportunity.Responsable__c}&quot;;
var idDest = &quot;{!Opportunity.Destinatario_de_Mercaderia__c}&quot;;

var rt = sforce.connection.query(&quot;SELECT Id, Name FROM RecordType WHERE Id = &apos;&quot;+rt_opp+ &quot;&apos; limit 1&quot;);
records = rt.getArray(&quot;records&quot;);
rt_VB = records[0].Name.toString();
var cLogistico = &apos;&apos;;
if(idOrigen != null &amp;&amp; idOrigen != &apos;&apos;){

var sucu = sforce.connection.query(&quot;Select Origen__r.Name FROM Opportunity WHERE Id = &apos;&quot;+id+ &quot;&apos; limit 1&quot;);
var sucur = sucu.getArray(&quot;records&quot;);
cLogistico = sucur[0].Origen__r.Name.toString();

//var suc = sforce.connection.query(&quot;Select Id, Name FROM Centro_Logistico__c WHERE Id = &apos;&quot;+idOrigen+ &quot;&apos; limit 1&quot;);
//sucursal = suc.getArray(&quot;records&quot;);
//cLogistico = sucursal[0].Name.toString();
}


var pasa = true;

if (tipo.substring(0,4) != &apos;ZBNC&apos;){

if(tieneOpli == false){
alert(&apos;Opp sem Produtos.&apos;);
pasa = false;
}

if(pasa &amp;&amp; (rt_VB == &apos;VB - Autorizada&apos; &amp;&amp; stage == &apos;AN - Anulada&apos;)){
alert(&apos;Venda da Basica Anulada&apos;);
pasa = false;
}

//if (fecha_tipo_cambio == &apos;&apos; &amp;&amp; rt_VB != &apos;Pendiente&apos;){
//alert(&apos;Falta fecha fijacion tipo de cambio&apos;);
//pasa = false;
//}

//if (pasa &amp;&amp; tipo_cambio == &apos;&apos;){
//alert(&apos;Falta tipo de cambio&apos;);
//pasa = false;
//}

if (pasa &amp;&amp; (sucursal == &apos;&apos; &amp;&amp; idOrigen == &apos;&apos;)){
alert(&apos;Falta sucursal&apos;);
pasa = false;
}
if (pasa &amp;&amp;(rt_VB == &apos;CVB Pendiente&apos; &amp;&amp; (idDest == null || idDest== &apos;&apos;))){
alert(&apos;Falta Destinatario&apos;);
pasa = false;
}

//if (pasa &amp;&amp; condicion_pago == &apos;&apos;){
//alert(&apos;Falta Condicion de Pago&apos;);
//pasa = false;
//}

if(pasa &amp;&amp; rt_VB == &apos;CVB Pendiente&apos;){
var result = sforce.apex.execute(&quot;Opp_Utils&quot;,&quot;validarPasoVBSAP&quot;, {opId : id});

if (result[1] != &apos;OK&apos;){
alert(result[0]);
pasa = false;
}
}


}
if(tipo.substring(0,4) == &apos;ZBNC&apos; &amp;&amp; cLogistico.indexOf(&apos;Passo&apos;) != -1){
alert(&apos;Por favor atualizar no SAP, na transação VA02 o código de imposto para I9.&apos;);
}
if (pasa) {
var result = sforce.apex.execute(&quot;Opp_Sap_Alta&quot;,&quot;enviarSAP&quot;, {oppId : id, etapa : stage, target : 200});
alert(&apos;Proceso Terminado.&apos;);

window.location.reload(true);

//alert(&quot;Momentaneamente inhabilitado.&quot;);
}</url>
</WebLink>
