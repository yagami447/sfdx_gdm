<apex:page lightningStyleSheets="true" standardController="Resumo_da_conta__c" action="{!getEstados}" extensions="EstadoCRMExtension" sidebar="false" showHeader="false" standardStylesheets="false" applyHtmlTag="false" applyBodyTag="false" docType="html-5.0">
<head>
    <apex:stylesheet value="{!URLFOR($Resource.SLDS, 'assets/styles/salesforce-lightning-design-system.min.css')}"/>
</head>
<div class="SLDS">

<body>
    <apex:form >        
        
        <div class="slds-page-header slds-page-header_object-home" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <div class="slds-grid">
                <div class="slds-col">
                    <div class="slds-media slds-no-space slds-grow">
                        <div class="slds-media__figure">
                            <svg aria-hidden="true" class="slds-icon slds-icon-standard-goals">
                                <use xlink:href="{!URLFOR($Resource.SLDS, '/assets/icons/standard-sprite/svg/symbols.svg#goal')}"></use>
                            </svg>
                        </div>                            
                        <div class="slds-media__body">
                            <p class="slds-text-title--caps slds-line-height--reset">Adiciona Estado a </p>
                            <p class="slds-page-header__title slds-truncate" title="ALL">{!Resumo_da_conta__c.Name}</p>
                        </div>
                    </div>                    
                </div>
                <div class="slds-col slds-no-flex slds-grid slds-align-top">
                    <apex:outputPanel >
                        <apex:commandLink styleClass="slds-button slds-button--neutral slds-not-selected" value="Salvar" action="{!Save}" target="_parent" />
                        <apex:commandButton styleClass="slds-button slds-button--brand slds-not-selected" action="{!Cancel}" value="Cancelar" immediate="true" html-formnovalidate="formnovalidate" />
                    </apex:outputPanel>
                </div>
            </div>
            <div class="slds-grid">
                <div class="slds-col slds-align-bottom">
                    <p class="slds-text-body_large">Estado Selecionados </p>
                </div>
            </div>
            <apex:outputPanel styleClass="fyi" id="mess" >
                <apex:messages />
            </apex:outputpanel>
        </div>

          <apex:outputPanel id="selected">
            <table class="slds-table slds-table--bordered slds-table--cell-buffer">
            <thead>
                <tr class="slds-text-title--caps">                    
                    <th scope="col">
                        <div class="slds-truncate" title="Action"></div>
                    </th>
                    <th scope="col">
                        <div class="slds-truncate">{!$ObjectType.Estado_Para_CRM__c.Fields.Estado__c.Label}</div>
                    </th>
                    <th scope="col">
                        <div class="slds-truncate">{!$ObjectType.Estado_Para_CRM__c.Fields.Percentagem_de_venda__c.Label}</div>
                    </th>
                </tr>
            </thead>
            <tbody>
                <apex:repeat value="{!estadosAlreadySelected}" var="s">
                    <tr>
                        <td>
                            <div class="slds-truncate" title="Action">
                                <apex:commandButton styleClass="slds-button" value="Excluir" action="{!removeFromEstadosAlreadySelected}" reRender="selected,searchResults">
                                <apex:param value="{!estadosAlreadySelected[s].Indice__c}" assignTo="{!toRemove}" name="toRemove" />
                                </apex:commandButton>                            
                            </div>
                        </td>                        
                        <td data-label="{!estadosAlreadySelected[s].Estado__c}">
                            <div class="slds-truncate" title="{!estadosAlreadySelected[s].Estado__c}">
                                <apex:outputField value="{!estadosAlreadySelected[s].Estado__c}"/>
                            </div>
                        </td>    
                        <td data-label="{!estadosAlreadySelected[s].Percentagem_de_venda__c}">
                            <div class="slds-truncate" title="{!estadosAlreadySelected[s].Percentagem_de_venda__c}">
                                <apex:inputField value="{!estadosAlreadySelected[s].Percentagem_de_venda__c}"/>
                            </div>
                        </td>                      
                      </tr>
                </apex:repeat>
            </tbody>
            </table>
            </apex:outputPanel> 
        
        <apex:outputpanel id="search">
        <div class="slds-page-header slds-page-header_object-home" style="" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
        <div class="slds-grid slds-grid_vertical">
          <div class="slds-p-vertical_x-small slds-p-horizontal_large slds-shrink-none slds-theme_shade">
           <div class="slds-form-element">              
              <!--<div class="slds-form-element__control"> -->
                <div class="slds-combobox_container">
                  <div class="slds-combobox slds-dropdown-trigger slds-dropdown-trigger_click" aria-expanded="false" aria-haspopup="listbox" role="combobox">
                    <div class="slds-combobox__form-element slds-input-has-icon slds-input-has-icon_right">                      
                      <apex:actionRegion renderRegionOnly="false" immediate="true">
                          <apex:actionFunction name="fetchResults" action="{!getEstados}" reRender="searchResults, mess, count" status="searchStatus"/>
                          <apex:input type="text" html-placeholder="Pesquisar obtentor:" styleClass="slds-input slds-combobox__input"
                          value="{!searchString}" onkeydown="if(event.keyCode==13){this.blur();}else{resetTimer();}" />                      
                          <span class="slds-icon_container slds-icon-utility-search slds-input__icon slds-input__icon_right">
                          <svg class="slds-icon slds-icon slds-icon_x-small slds-icon-text-default" aria-hidden="true">
                              <use xlink:href="{!URLFOR($Resource.SLDS, '/assets/icons/utility-sprite/svg/symbols.svg#search')}"></use>
                          </svg>                          
                          </span>
                          <apex:actionStatus id="searchStatus" startText="Pesquisando..." stopText=" "/>
                      </apex:actionRegion>
                    </div>
                  </div>
                <!--</div> -->
              </div>
            </div>            
          </div>
          </div>
          </div>
          </apex:outputpanel>
          <apex:outputpanel styleclass="slds-grid" id="searchResults">
              <table class="slds-table slds-table--bordered slds-table--cell-buffer slds-table_fixed-layout">
              <thead>
                  <tr class="slds-text-title--caps">
                    <th scope="col">
                        <div class="slds-truncate" title="Action">                            
                        </div>
                    </th>
                    <th scope="col">
                        <div class="slds-truncate" title="{!$ObjectType.Estado_para_CRM__c.Fields.Estado__c.Label}">
                            {!$ObjectType.Estado_para_CRM__c.Fields.Estado__c.Label}
                        </div>
                    </th>                    
                  </tr>
              </thead>
              <tbody>
                  <apex:repeat value="{!estados}" var="a">
                      <tr>
                        <td>
                            <div class="slds-truncate" title="Action">
                                <apex:commandButton styleClass="slds-button slds-button--neutral" value="Adicionar" action="{!addToEstadosAlreadySelected}" reRender="selected, mess, count, searchResults">
                                <apex:param value="{!a.estado}" assignTo="{!toAdd}" name="toAdd"/>
                                </apex:commandButton>                            
                            </div>
                        </td>
                        <th scope="row" data-label="{!a.Estado}">
                            <div class="slds-truncate" title="{!a.Estado}">
                                <apex:outputText value="{!a.Estado}"/>
                            </div>
                        </th>              
                      </tr>
                  </apex:repeat>
              </tbody>
              </table>              
          </apex:outputpanel>                          
        </apex:form>
</body>
</div>
    
<script type='text/javascript'>
    
    // Esta variable indica el tiempo (segs) que se toma en ejecutar la busqueda, para cambiarla, cambiar este valor            
    var waitTime = 1; 

    var countDown = waitTime+1;
    var started = false;
    
    function resetTimer(){        
        countDown=waitTime+1;            
        if(started==false){
            started=true;
            runCountDown();
        }
    }        
    function runCountDown(){        
        countDown--;            
        if(countDown<=0){
            fetchResults();
            started=false;
        }
        else{
            window.setTimeout(runCountDown,500);
        }
    }

</script>
</apex:page>